{% extends "core/base.html" %}
{% load markdown_deux_tags static %}

{% block title %}{{ post.meta_title|default:post.title }} - MySocket{% endblock %}

{% block meta_description %}
<meta name="description" content="{{ post.meta_description|default:post.content|striptags|truncatewords:25 }}">
{% endblock %}

{% block opengraph_tags %}
  <!-- OpenGraph мета-теги для статьи -->
  <meta property="og:site_name" content="MySocket: Ваш IT-партнёр">
  <meta property="og:type" content="article">
  <meta property="og:title" content="{{ post.meta_title|default:post.title }}">
  <meta property="og:description" content="{{ post.meta_description|default:post.content|striptags|truncatewords:25 }}">
  <meta property="og:url" content="{{ request.scheme }}://{{ site.domain }}{{ post.get_absolute_url }}">
  {# В будущем здесь будет ссылка на обложку статьи, пока что - заглушка #}
  <meta property="og:image" content="{{ request.scheme }}://{{ site.domain }}{% static 'images/logo_og.png' %}">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:locale" content="ru_RU">
  
  <!-- Дополнительные теги для типа "article" -->
  <meta property="article:published_time" content="{{ post.published_date|date:'c' }}">
  <meta property="article:author" content="{{ post.author.get_full_name|default:post.author.username }}">
  {% for tag in post.tags.all %}
  <meta property="article:tag" content="{{ tag.name }}">
  {% endfor %}

  <!-- Микроразметка Schema.org для статьи (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "{{ post.title|escapejs }}",
    "author": {
      "@type": "Person",
      "name": "{{ post.author.get_full_name|default:post.author.username|escapejs }}"
    },
    "publisher": {
        "@type": "Organization",
        "name": "MySocket: Ваш IT-партнёр",
        "logo": {
            "@type": "ImageObject",
            "url": "{{ request.scheme }}://{{ site.domain }}{% static 'images/logo_og.png' %}"
        }
    },
    "datePublished": "{{ post.published_date|date:'c' }}",
    "description": "{{ post.meta_description|default:post.content|striptags|truncatewords:30|escapejs }}",
    "image": "{{ request.scheme }}://{{ site.domain }}{% static 'images/logo_og.png' %}",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "{{ request.scheme }}://{{ site.domain }}{{ post.get_absolute_url }}"
    }
  }
  </script>

  <!-- Микроразметка Schema.org для "хлебных крошек" (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [{
      "@type": "ListItem",
      "position": 1,
      "name": "Главная",
      "item": "{{ request.scheme }}://{{ site.domain }}{% url 'home' %}"
    },{
      "@type": "ListItem",
      "position": 2,
      "name": "Статьи",
      "item": "{{ request.scheme }}://{{ site.domain }}{% url 'article_list' %}"
    }
    {% if post.category %}
    ,{
      "@type": "ListItem",
      "position": 3,
      "name": "{{ post.category.name|escapejs }}",
      "item": "{{ request.scheme }}://{{ site.domain }}{{ post.category.get_absolute_url }}"
    },{
      "@type": "ListItem",
      "position": 4,
      "name": "{{ post.title|escapejs }}"
    }
    {% else %}
    ,{
      "@type": "ListItem",
      "position": 3,
      "name": "{{ post.title|escapejs }}"
    }
    {% endif %}
    ]
  }
  </script>
{% endblock opengraph_tags %}


{% block content %}
  <div class="max-w-4xl mx-auto">
    
    <!-- "Хлебные крошки" для навигации -->
    <div class="text-sm text-gray-400 mb-4">
      <a href="{% url 'home' %}" class="hover:text-cyan-400">Главная</a> &raquo;
      <a href="{% url 'article_list' %}" class="hover:text-cyan-400">Статьи</a>
      {% if post.category %}
        &raquo; <a href="{{ post.category.get_absolute_url }}" class="hover:text-cyan-400">{{ post.category.name }}</a>
      {% endif %}
    </div>

    <!-- Заголовок статьи -->
    <h1 class="text-4xl font-bold text-cyan-400 mb-2">{{ post.title }}</h1>
    
    <!-- Мета-информация -->
    <div class="text-sm text-gray-400 mb-8">
      <span>Автор: {{ post.author.get_full_name|default:post.author.username }}</span> |
      <span>Опубликовано: {{ post.published_date|date:"d E Y" }}</span>
    </div>

    <!-- Основной контент статьи -->
    <div class="prose prose-invert max-w-none">
      {{ post.content|markdown }}
    </div>

    <!-- Теги -->
    {% if post.tags.all %}
      <div class="mt-8 pt-4 border-t border-gray-700">
        <span class="text-gray-400">Теги:</span>
        {% for tag in post.tags.all %}
          <a href="{{ tag.get_absolute_url }}" class="inline-block bg-gray-700 text-cyan-400 text-sm font-semibold px-3 py-1 rounded-full ml-2 hover:bg-gray-600">
            {{ tag.name }}
          </a>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Блок: Похожие статьи -->
    {% if related_posts %}
    <div class="mt-16 pt-8 border-t border-gray-700">
      <h2 class="text-3xl font-bold text-gray-200 mb-6">Похожие статьи</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for related_post in related_posts %}
          <a href="{{ related_post.get_absolute_url }}" class="block bg-gray-800 p-4 rounded-lg hover:bg-gray-700 transition-colors duration-300">
            <h3 class="font-semibold text-lg text-cyan-400">{{ related_post.title }}</h3>
            <p class="text-sm text-gray-400 mt-2">Опубликовано: {{ related_post.published_date|date:"d E Y" }}</p>
          </a>
        {% endfor %}
      </div>
    </div>
    {% endif %}
    <!-- Конец блока: Похожие статьи -->

    <!-- Кнопка "Назад" -->
    <div class="mt-12">
      <a href="{% url 'article_list' %}" class="text-cyan-400 hover:text-cyan-300">← Вернуться к списку статей</a>
    </div>

  </div>
{% endblock %}